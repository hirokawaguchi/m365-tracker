services:
  m365-tracker:
    build: .
    container_name: m365-tracker
    volumes:
      - whitelist-data:/etc/squid/whitelist
      - ./config:/app/config
      - ./logs:/app/logs
    environment:
      - UPDATE_INTERVAL=3600
      - LOG_LEVEL=INFO
    restart: unless-stopped
    depends_on:
      squid:
        condition: service_started

  squid:
    image: ubuntu/squid:latest
    container_name: squid-proxy
    ports:
      - "3128:3128"
    volumes:
      - whitelist-data:/etc/squid/whitelist
      - ./config/squid.conf:/etc/squid/squid.conf:ro
      - squid-cache:/var/spool/squid
      - squid-logs:/var/log/squid
    restart: unless-stopped
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        # ホワイトリストディレクトリとファイルの作成
        mkdir -p /etc/squid/whitelist
        touch /etc/squid/whitelist/whitelist.txt
        touch /etc/squid/whitelist/whitelist_ips.txt
        # Squid用ディレクトリの準備
        mkdir -p /var/spool/squid /var/log/squid /var/run/squid
        chown -R proxy:proxy /var/spool/squid /var/log/squid /var/run/squid /etc/squid/whitelist
        # 既存のPIDファイルを削除
        rm -f /var/run/squid/squid.pid
        # Squidキャッシュディレクトリを初期化
        squid -z 2>&1 || true
        sleep 2
        # Squidを起動
        exec squid -N -d 1

volumes:
  whitelist-data:
  squid-cache:
  squid-logs:
